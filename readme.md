# AHF KRACH Calculator

## Quick-Start
TODO

## Overview
This tool attempts to reproduce the KRACH rankings, as generated by the AHF.

KRACH stands for [Ken's Rating for American College Hockey](http://elynah.com/tbrw/tbrw.cgi?krach). It's commonly used to generate rankings when not all teams play each other an equal number of times. This includes schedules where teams may not play each other at all.  More details later, but in short it combines the win/loss ratio of each team, with their strength of schedule.

AHF is the [Atlantic Hockey Federation](http://elynah.com/tbrw/tbrw.cgi?krach). Like many leagues, the AHF uses KRACH to determine division rankings and hence playoff berths.

This tool is focused on the AHF ratings for the selfish reason that it's the league my son plays in :)

# KRACH Implementation Details

KRACH takes the [Bradley-Terry Model](https://en.wikipedia.org/wiki/Bradley%E2%80%93Terry_model) and applies it to hockey.  There's almost no hockey-specific calculations, making KRACH general enough to be applied to any sport.

From the Wikipedia page on Bradley-Terry, the basic algorithm to calculate the rating for a team is:

```
  P'i = Wi / ( ∑j Nij / (Pi + Pj) )

Where:
  P'i : New rating for i
  Pi  : Current rating for i
  Pj  : Current rating for j
  Wi  : Total wins by i
  Nij : Number of times i and j have competed against each other.
```

The algorithm is recursive, in that you need a current rating to calculate a new rating.  To deal with this, all teams are assigned the same default rating (1). This is used to calculate the first set of new ratings which are normalized then fed back into the algorithm.  This is repeated until the results converge on the 'final' set of ratings.

Note, http://elynah.com/tbrw/tbrw.cgi?krach has several different equivalant formalations of the algorithm, but includes this version, identical to the one above:

```
Ki = Vi / [ ∑j Nij / (Ki + Kj) ]
```

The tool provided here implements this variation of the algorithm.  As discussed elsewhere, this avoids needing to specifically deal with undefeated teams.

# AHF Specifics

Some specifics on the AHF season, and what it means for calculating KRACH values.

## Ties, or Lack Thereof

The big difference between the base Bradley-Terry model, and KRACH, is that KRACH takes tie games into account. It does this by weighing the tie as half a win (and half a loss) for both teams.

But in the AHF, no game ends in a tie; if the score is tied at the end of regulation, it immediately goes to a shootout that continues until one team is victorious.

**At the time of this writing, I do not know how the AHF weighs shootouts when calculating the KRACH ratings**.  I've tried reaching out, but so far no response.

The simple answer would be to ignore the fact it was a shootout, and count it as a straightforward win/loss. After experimenting with real data, I don't think this is the case, as the resulting rankings are just too different from what the AHF publishes.

So there's likely some amount of partial credit.  The basic approach in this case is to count the game as a tie; afterall the teams did tie; the shootout is a skills competition between individuals.  Experimentation shows that this gets results far closer to the AHF results, but still not an exact match.

## Undefeated Teams

There are a couple different equivalent definitions of the KRACH algorithm. One method is as follows:

```
KRACH = ((Wins + 0.5 * Ties) / (losses + 0.5 * Ties)) * (SoS)

Where:
  SoS = strength of schedule, which is based on the KRACH ratings of all teams this team has played)
```

This will divide-by-zero if a team is undefeated. And since there is an undefeated team in our division, I thought I needed to find a way around this.  Turns out that not all variations of the KRACH algorithm have this divide-by-zero risk. My "fix" for this tool was to use one of those variations.  **At the time of this writing, I do not know which method the AHF uses to calculates KRACH** so they may or may not have a workaround implemented to deal with undefeated teams. I have reached out to the AHF about their algorithm; depending on their response, the rest of this section may end up being relevant, but was left for informational purposes:

The _Dealing with Perfection_ section at http://elynah.com/tbrw/tbrw.cgi?krach discusses this problem. One solution is to use a fake team and pretend that it has tied every team:

> An older version of KRACH got around this by adding a "fictitious team" against which each team was assumed to have played and tied one game, which was enough to make everyone's KRACH finite. However, this had the disadvantage that it could still effect the ratings even when it was no longer needed to avoid infinities.

In contrast, http://dbaker.50webs.com/method.html suggests using 3 fictional ties per team:

> Prior to the 2011 football season, I used only one such tie game, but this tended to predict unrealistically high win percentages for unbeaten teams. The change to three fictional games tends to push down teams who have mediocre records against great schedules, as compressing the rating scale in this manner weakens more of their opponents' ratings than it improves. This mitigates one of the main criticisms of KRACH (which no longer uses the fictional game at all): a team can get to a fairly high rank purely by being in a tough conference, even if they do very poorly. This is exacerbated by the high percentage of games in conference in hockey (about 80%, compared to 65% for football or basketball).

As indicated by both sites, KRACH no longer uses the "fake" tie method. Unfortunately for me, trying to write this tool, it's not clear what it uses instead.  At http://elynah.com/tbrw/tbrw.cgi?krach it says:

> The current version of KRACH does not include this "fictitious team", but rather checks to see if any ratios of ratings will end up needing to be infinite to produce the correct expected winning percentages. The key turns out to be related to the old game of trying to prove that the last-place team is better than the first-place team because they beat someone who beat someone who beat someone who beat the champions. If you can take any two teams and make a chain of wins or ties from one to the other, then all of the KRACH ratings will be finite.
> 
> If that's not the case, you need to work out the relationships teams have to each other. ....

The paragraph continues on, but honestly my mind has glazed over every time I read it. And having an alternative algorithm without the divide-by-zero risk means I never had to spend the time trying to fully absorb this section.

## Part-time Teams

Some teams in the AHF are part-time, and end up playing a significantly reduced schedule compared to the full-time teams.  This is another reason why a ranking system based on straight wins-losses would not be feasible.  KRACH treats the part-time teams just like any other team, and relies on the strength-of-schedule component to produce accurrate ratings.

Other than the reduced schedule, part-time teams are treated identically to other teams, and are eligible for playoffs.

## Showcase Teams

The AHF schedules multiple showcases throughout the season. A showcase is a weekend where all teams from the league converge on a single rink, and each team plays 4 games.  These games are normal regular season games, and count towards everyones record (including the KRACH ratings).

Sometimes, showcases incorporate a team that isn't in our league at all; these teams are only in town to play 4 games in the showcase, and then our league will never see them again.

What's odd about this, is that the games are still treated as regular season games, and still count towards the KRACH ratings.  In other words, these one-off showcase teams are a part-time team, but one that is not eligible for the playoffs. And in fact, if you look at the league standings, you'll see these teams listed as if they were a normal league team.

